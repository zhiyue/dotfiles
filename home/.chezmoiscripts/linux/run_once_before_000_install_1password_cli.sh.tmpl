#!/bin/bash

# 检查 1Password CLI 是否已安装
if command -v op >/dev/null 2>&1; then
  echo "1Password CLI 已安装，跳过安装步骤"
  exit 0
fi

echo "安装 1Password CLI..."

# 创建临时目录
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR" || exit 1

# 下载并解压
curl -sSO https://downloads.1password.com/linux/tar/stable/x86_64/1password-cli.tar.gz
curl -sSO https://downloads.1password.com/linux/tar/stable/x86_64/1password-cli.tar.gz.sig
tar -xf 1password-cli.tar.gz

# 验证真实性（可选，如果失败则继续）
if command -v gpg >/dev/null 2>&1; then
  echo "验证下载文件的真实性..."
  gpg --keyserver keyserver.ubuntu.com --receive-keys 3FEF9748469ADBE15DA7CA80AC2D62742012EA22 || true
  gpg --verify 1password-cli.tar.gz.sig 1password-cli.tar.gz || echo "警告：验证失败，但继续安装"
else
  echo "未找到 gpg 命令，跳过验证"
fi

# 移动到系统目录
if [ -f op ]; then
  sudo mv op /usr/local/bin/

  # 设置权限
  sudo groupadd -f onepassword-cli
  sudo chown root:onepassword-cli /usr/local/bin/op
  sudo chmod 0755 /usr/local/bin/op
  
  echo "1Password CLI 安装完成"
else
  echo "错误：未找到 op 文件，安装失败"
  exit 1
fi

# 清理临时文件
cd "$HOME" || exit 1
rm -rf "$TEMP_DIR"

# 确认安装
if command -v op >/dev/null 2>&1; then
  echo "验证 1Password CLI 版本："
  op --version
else
  echo "错误：安装似乎失败，无法找到 op 命令"
  exit 1
fi

exit 0