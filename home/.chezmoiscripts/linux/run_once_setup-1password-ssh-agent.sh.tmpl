#!/bin/bash

# Only run this script in WSL
{{- if and (eq .chezmoi.os "linux") (contains "microsoft" .chezmoi.kernel.osrelease) }}

echo "Setting up 1Password SSH agent integration for WSL..."

# Create .ssh directory if it doesn't exist
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Create .1password directory for the agent socket
mkdir -p ~/.1password
chmod 700 ~/.1password

# Create aliases for SSH commands in .bashrc
if ! grep -q "# 1Password SSH agent aliases" ~/.bashrc; then
    echo "" >> ~/.bashrc
    echo "# 1Password SSH agent aliases" >> ~/.bashrc
    echo "alias ssh='ssh.exe'" >> ~/.bashrc
    echo "alias ssh-add='ssh-add.exe'" >> ~/.bashrc
    echo "alias ssh-agent='ssh-agent.exe'" >> ~/.bashrc
    echo "alias ssh-keygen='ssh-keygen.exe'" >> ~/.bashrc
    echo "" >> ~/.bashrc
    echo "# 1Password SSH agent environment variables" >> ~/.bashrc
    echo "export SSH_AUTH_SOCK=~/.1password/agent.sock" >> ~/.bashrc
fi

# Copy SSH config if it doesn't exist
if [ ! -f ~/.ssh/config ]; then
    cp {{ .chezmoi.sourceDir }}/.chezmoitemplates/dot_ssh_config.wsl ~/.ssh/config
    chmod 600 ~/.ssh/config
fi

echo "1Password SSH agent integration setup complete!"
echo "Please restart your WSL session or run 'source ~/.bashrc' to apply the changes."
echo "Remember to update your SSH public key in the gitconfig file."

{{- end }}
